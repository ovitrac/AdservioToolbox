# Cheat Sheet — Level 3: Advanced

## MCP Server Architecture

`toolboxctl init` registers two MCP servers in `.claude/settings.json` (project-local):

```json
{
  "mcpServers": {
    "memctl": {
      "command": "memctl",
      "args": ["serve"]
    },
    "cloakmcp": {
      "command": "cloak",
      "args": ["serve"]
    }
  }
}
```

> **Settings file locations:** Claude Code merges settings from multiple files.
> `toolboxctl init` writes to `.claude/settings.json` (project-local).
> The sub-project installers write hooks and MCP config to different files:
>
> | Script | Writes to | Scope |
> |--------|-----------|-------|
> | `toolboxctl init` | `.claude/settings.json` | Project (MCP servers) |
> | CloakMCP `install_claude.sh` | `.claude/settings.local.json` | Project (hooks) |
> | memctl `install_eco.sh` | `.claude/settings.local.json` | Project (eco hook + MCP) |
> | memctl `install_mcp.sh` | `~/.claude/settings.json` | User-global (MCP) |
> | memctl `install_claude_hooks.sh` | `~/.claude/settings.json` | User-global (hooks) |
>
> If both `toolboxctl init` and `install_eco.sh` are run, memctl MCP may be registered
> in two files. Claude Code deduplicates by server name, so this is harmless.

### memctl MCP Server

Started via `memctl serve`. Exposes 14 `memory_*` tools:

| Tool | Description |
|------|-------------|
| `memory_inspect` | Structural overview of a directory (file tree, sizes) |
| `memory_recall` | Selective content retrieval (FTS5, token-budgeted) |
| `memory_propose` | Store a finding/observation |
| `memory_loop` | Iterative refinement (bounded, convergence-detecting) |
| `memory_consolidate` | Cluster and merge similar STM items → MTM |
| `memory_sync` | Scan and ingest mounted folders |
| `memory_stats` | Report memory state and budget |

### CloakMCP MCP Server

Started via `cloak serve` (auto-discovers `.cloak/policy.yaml`). Exposes 6 tools:

| Tool | Description |
|------|-------------|
| `cloak_scan_text` | Scan text for secrets |
| `cloak_sanitize_text` | Sanitize text (replace secrets with tags) |
| `cloak_pack_dir` | Pack a directory (vault secrets) |
| `cloak_unpack_dir` | Unpack a directory (restore from vault) |
| `cloak_policy_show` | Show merged policy |
| `cloak_vault_stats` | Report vault statistics |

## Policy System

### CloakMCP Detection Policies

Detection rules are defined in `.cloak/policy.yaml` under the `detection` key.
Each rule requires `id`, `type`, and `action` fields:

```yaml
version: 1
globals:
  default_action: redact
  audit:
    enabled: true
    path: ./audit/audit.jsonl

detection:
  - id: api_keys
    type: regex
    pattern: "sk-[a-zA-Z0-9_-]{20,}"
    action: redact
    severity: critical

  - id: jwt_tokens
    type: regex
    pattern: "eyJ[A-Za-z0-9_-]+\\.eyJ[A-Za-z0-9_-]+"
    action: redact
    severity: critical

  - id: ssh_private_keys
    type: regex
    pattern: "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----"
    action: redact
    severity: critical

  - id: high_entropy_strings
    type: entropy
    min_entropy: 4.0
    min_length: 20
    action: redact
    severity: medium
```

### Rule Types

| Type | Required Fields | Description |
|------|----------------|-------------|
| `regex` | `pattern` | Regular expression matching |
| `entropy` | `min_entropy`, `min_length` | Shannon entropy threshold |
| `ipv4` | — | IPv4 address detection (CIDR whitelist supported) |
| `ipv6` | — | IPv6 address detection |
| `url` | — | URL detection |

### Actions

| Action | Behavior |
|--------|----------|
| `redact` | Replace with tag (vaulted, reversible) |
| `block` | Refuse to process |
| `allow` | Explicitly permit |
| `pseudonymize` | HMAC-based pseudonymization |
| `replace_with_template` | Replace with template string |

### Policy Inheritance

Policies can inherit from parents via `inherits`:

```yaml
inherits:
  - ./base-policy.yaml
detection:
  - id: custom_internal
    type: regex
    pattern: "INTERNAL_[A-Z_]+"
    action: redact
    severity: low
```

Rules with the same `id` in the child override the parent.

### Policy Management

```bash
# Anchor a policy for cloak serve auto-discovery (0.8.2+)
cloak policy use mcp_policy.yaml                    # bundled 10-rule default
cloak policy use mcp_policy_enterprise.yaml          # bundled 26-rule enterprise
cloak policy use /path/to/custom-policy.yaml         # custom policy

# Show active policy
cloak policy use --show

# Validate policy (including inheritance chain)
cloak policy validate --policy .cloak/policy.yaml

# Show merged policy after inheritance
cloak policy show --policy .cloak/policy.yaml
cloak policy show --policy .cloak/policy.yaml --format json
```

## FTS Tokenizer Configuration

memctl uses SQLite FTS5 for full-text search. The tokenizer affects search behavior:

| Tokenizer | Flag | Behavior |
|-----------|------|----------|
| French (default) | `--fts fr` | French stemming, accent folding |
| English | `--fts en` | Porter stemming |
| Raw | `--fts raw` | No stemming, exact match |

### Setting at Install Time

```bash
# French content (default)
toolboxctl install --fts fr
toolboxctl init --fts fr

# English content
toolboxctl install --fts en
toolboxctl init --fts en

# No stemming
toolboxctl install --fts raw
toolboxctl init --fts raw
```

The FTS setting is stored in `.adservio-toolbox.toml` under `memctl.fts`.

## Hooks Integration

### CloakMCP Hooks (Secret Protection)

Installer scripts are bundled in the PyPI wheel. Use `cloak scripts-path` to locate them:

```bash
# Install
bash "$(cloak scripts-path)/install_claude.sh"                       # secrets-only profile (5 hooks)
bash "$(cloak scripts-path)/install_claude.sh" --profile hardened     # + Bash safety guard (6 hooks)
bash "$(cloak scripts-path)/install_claude.sh" --method symlink       # symlink instead of copy
bash "$(cloak scripts-path)/install_claude.sh" --dry-run              # preview without changes

# Uninstall
bash "$(cloak scripts-path)/install_claude.sh" --uninstall            # remove all hooks
bash "$(cloak scripts-path)/install_claude.sh" --uninstall --dry-run  # preview uninstall
```

Creates scripts in `.claude/hooks/` and merges hook config into `.claude/settings.local.json`:

| Hook Script | Event | Matcher | Purpose |
|-------------|-------|---------|---------|
| `cloak-session-start.sh` | SessionStart | `startup` | `cloak pack` — secrets → TAG-xxx |
| `cloak-session-end.sh` | SessionEnd | — | `cloak unpack` — TAG-xxx → secrets |
| `cloak-prompt-guard.sh` | UserPromptSubmit | — | Warn if prompt contains raw secrets |
| `cloak-guard-write.sh` | PreToolUse | `Write\|Edit` | Block writes containing secrets |
| `cloak-safety-guard.sh` | PreToolUse | `Bash` | Block dangerous commands (hardened only) |
| `cloak-audit-logger.sh` | PostToolUse | `Write\|Edit\|Bash` | Audit log of tool invocations |

### memctl Hooks

Installer scripts are bundled in the PyPI wheel. Use `memctl scripts-path` to locate them:

```bash
# MCP server registration
bash "$(memctl scripts-path)/install_mcp.sh"                          # Claude Code (default)
bash "$(memctl scripts-path)/install_mcp.sh" --client claude-desktop  # Claude Desktop
bash "$(memctl scripts-path)/install_mcp.sh" --client all --yes       # both clients
bash "$(memctl scripts-path)/install_mcp.sh" --dry-run                # preview changes

# Eco mode (hook + strategy file + /eco slash command)
bash "$(memctl scripts-path)/install_eco.sh" --db-root .memory        # install eco mode
bash "$(memctl scripts-path)/install_eco.sh" --dry-run                # preview changes
bash "$(memctl scripts-path)/install_eco.sh" --yes --force            # non-interactive, overwrite

# Safety guard + audit logger hooks
bash "$(memctl scripts-path)/install_claude_hooks.sh"                 # install PreToolUse + PostToolUse hooks
bash "$(memctl scripts-path)/install_claude_hooks.sh" --dry-run       # preview changes
```

**Uninstallers:**

```bash
bash "$(memctl scripts-path)/uninstall_mcp.sh"                        # remove MCP config + hooks
bash "$(memctl scripts-path)/uninstall_mcp.sh" --hooks-only           # remove hooks only, keep MCP
bash "$(memctl scripts-path)/uninstall_mcp.sh" --mcp-only             # remove MCP only, keep hooks
bash "$(memctl scripts-path)/uninstall_mcp.sh" --client all           # remove from both clients

bash "$(memctl scripts-path)/uninstall_eco.sh"                        # remove eco hook + strategy + /eco
bash "$(memctl scripts-path)/uninstall_eco.sh" --dry-run              # preview changes
```

The eco uninstaller **preserves** `.memory/memory.db` (user data) and MCP server config.

### What Each memctl Installer Does

| Script | Creates | Modifies |
|--------|---------|----------|
| `install_mcp.sh` | — | `~/.claude/settings.json` or `claude_desktop_config.json` |
| `install_eco.sh` | `.claude/hooks/eco-hint.sh`, `.claude/eco/ECO.md`, `.claude/commands/eco.md` | `.claude/settings.local.json` |
| `install_claude_hooks.sh` | — | `~/.claude/settings.json` (adds PreToolUse + PostToolUse) |

### Hook Coexistence

| Aspect | CloakMCP hooks | memctl eco hook | memctl safety hooks |
|--------|---------------|-----------------|---------------------|
| Purpose | Secret sanitization | Token-efficient retrieval | Safety guard + audit |
| Events | SessionStart/End, UserPromptSubmit, PreToolUse, PostToolUse | UserPromptSubmit | PreToolUse, PostToolUse |
| Conflicts | None | None | None |
| Settings file | `.claude/settings.local.json` | `.claude/settings.local.json` | `~/.claude/settings.json` |

All hooks use Claude Code hooks but on **different events or different matchers**. They do not interfere.

## Environment Variables Reference

### Toolbox (bridged via `.adservio-toolbox.toml`)

| Variable | Config key | Default | Description |
|----------|-----------|---------|-------------|
| `ADSERVIO_ECO` | `eco.enabled_global` | `0` | Eco mode flag |
| `MEMCTL_DB` | `memctl.db` | `.memory/memory.db` | Memory database path |
| `MEMCTL_FTS` | `memctl.fts` | `fr` | FTS tokenizer |
| `MEMCTL_BUDGET` | `memctl.budget` | `2200` | Token budget |
| `MEMCTL_TIER` | `memctl.tier` | `stm` | Default memory tier |
| `CLOAK_POLICY` | `cloak.policy` | `.cloak/policy.yaml` | Policy file path |
| `CLOAK_MODE` | `cloak.mode` | `enforce` | Enforcement mode |
| `CLOAK_FAIL_CLOSED` | `cloak.fail_closed` | `0` | Fail-closed mode (block if policy missing) |

### CloakMCP-specific (set in shell or hooks)

| Variable | Default | Description |
|----------|---------|-------------|
| `CLOAK_PREFIX` | `TAG` | Tag prefix (`TAG-xxxxxxxxxxxx`) |
| `CLOAK_STRICT` | off | `1` = medium severity becomes blocking |
| `CLOAK_PROMPT_GUARD` | on | `off` = disable prompt secret detection |
| `CLOAK_REPACK_ON_WRITE` | off | `1` = auto-repack after each Write/Edit |
| `CLOAK_AUDIT_TOOLS` | off | `1` = log all tool invocations to audit |
| `CLOAK_FAIL_CLOSED` | off | `1` = block all if policy load fails |

## Claude Code — Advanced Features

### Headless Mode (CI/CD, Scripting)

```bash
claude -p "query"                          # non-interactive, print result
claude -p --output-format json "query"     # structured JSON output
claude -p --output-format stream-json "q"  # streaming JSON messages
echo "query" | claude -p                   # piped input
claude --max-turns 3 -p "task"             # limit agentic turns
claude -c -p "follow-up"                   # continue last session
claude --resume <id> -p "follow-up"        # resume specific session
```

### Permission Patterns

Defined in `.claude/settings.json` under `permissions.allow` / `permissions.deny`:

```json
{
  "permissions": {
    "allow": [
      "Bash(git:*)",
      "Bash(npm run *)",
      "Read",
      "Write",
      "mcp__memctl__*"
    ],
    "deny": [
      "Bash(rm -rf *)",
      "Bash(sudo *)"
    ]
  }
}
```

### Custom Slash Commands

Store `.md` files in `.claude/commands/` (team, committed) or `~/.claude/commands/` (personal):

```markdown
Describe what the command does.

Arguments: $ARGUMENTS

Use $1, $2, $3 for positional args or $ARGUMENTS for all.
```

### Hook Events Reference

| Event | When | Use Case |
|-------|------|----------|
| `SessionStart` | Claude starts | Initialize workspace (pack secrets) |
| `SessionEnd` | Claude exits | Cleanup (unpack secrets) |
| `UserPromptSubmit` | Each user message | Guard prompts, inject context |
| `PreToolUse` | Before tool execution | Block dangerous operations |
| `PostToolUse` | After tool execution | Audit logging |
| `Stop` | Claude stops responding | Notifications |
| `PreCompact` | Before context compaction | Save state |

Hook config in settings JSON:
```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": ".claude/hooks/guard.sh",
            "timeout": 10000
          }
        ]
      }
    ]
  }
}
```

### Settings Priority

```
/etc/claude-code/managed-settings.json   ← Enterprise (highest)
  ↓
.claude/settings.local.json              ← Project local (personal, git-ignored)
  ↓
.claude/settings.json                    ← Project shared (team, committed)
  ↓
~/.claude/settings.json                  ← User global (lowest)
```

## Release Pipeline

### Building release assets locally

```bash
# Build from pyproject.toml version
bash scripts/build-release.sh

# Override version
bash scripts/build-release.sh --version 0.2.0

# With GPG signature
bash scripts/build-release.sh --sign

# Preview actions
bash scripts/build-release.sh --dry-run

# Clean release directory
bash scripts/build-release.sh --clean
```

Output in `release/`:
```
install.sh                        # curl-installable bootstrap
install.ps1                       # Windows skeleton
adservio-toolbox-VERSION.tar.gz   # sdist
adservio-toolbox-VERSION.zip      # convenience archive
SHA256SUMS                        # checksums for all assets
SHA256SUMS.sig                    # optional GPG signature
```

### Publishing a release

```bash
# Manual
git tag -a v0.2.0 -m "Release 0.2.0"
git push origin v0.2.0
gh release create v0.2.0 release/* --title "v0.2.0" --notes-file CHANGELOG.md

# Automated: push a v* tag → GitHub Actions builds + publishes
```

### GitHub Actions workflow

`.github/workflows/release.yml` triggers on:
- Tag push (`v*`) — fully automated
- Manual `workflow_dispatch` — with version input and pre-release flag

Steps: checkout → setup Python → build → verify checksums → extract changelog → create release.

### Bootstrap installer tracks

The `install.sh` script detects capabilities and selects the best method:

| Track | Detection | Method |
|-------|-----------|--------|
| A (recommended) | `python3 -m pip` + `import venv` | pipx (isolated environments) |
| B (fallback) | `python3 -m pip` only | `pip install --user` |
| C (abort) | No Python or no pip | Prints distro-specific install instructions |

The installer never runs `sudo`. All privileged commands are printed for the user to run manually.

## Playground

The playground creates an isolated environment for testing:

```bash
# Create playground with venv + all deps
toolboxctl playground

# View test results
cat .playground/playground.log

# Clean up
toolboxctl playground --clean
```

### What the Playground Installs

1. `memctl[mcp,docs]` from PyPI
2. `cloakmcp` from PyPI
3. `adservio-toolbox` in editable mode

### Smoke Tests Run

1. `pip show memctl` — verify memctl installed
2. `pip show cloakmcp` — verify CloakMCP installed
3. `toolboxctl --version` — verify CLI works
4. `toolboxctl status` — verify status report

## Troubleshooting

### Common Issues

| Symptom | Cause | Fix |
|---------|-------|-----|
| `toolboxctl: command not found` | Not installed or not in PATH | `pip install -e .` or check `$PATH` |
| `No config file found` | Missing `.adservio-toolbox.toml` | Run `toolboxctl init` |
| `memctl: not installed` | memctl not in current env | Run `toolboxctl install` |
| `tomli not found` | Python 3.10 without fallback | `pip install tomli` |

### Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Success |
| `1` | Misconfiguration (missing config, invalid state) |
| `2` | Missing dependency (memctl, CloakMCP) |
